variant: fcos
version: 1.6.0

passwd:
  users:
    - name: lab
      groups: ["wheel"]
      shell: /bin/bash
      ssh_authorized_keys:
        - "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIDePN3gS12p0WDg0/9DkDZYwfMfb73qT3uW/yGiH+u57 hmlb"

systemd:
  units:
    - name: sshd.service
      enabled: true
      dropins:
        - name: 10-password-auth.conf
          contents: |
            [Service]
            ExecStartPre=/usr/bin/mkdir -p /etc/ssh/sshd_config.d
            ExecStartPre=/usr/bin/bash -c 'echo "PasswordAuthentication yes" > /etc/ssh/sshd_config.d/20-password-auth.conf'

    - name: k3s.service
      enabled: true
      contents: |
        [Unit]
        Description=K3s (single node)
        Wants=network-online.target
        After=network-online.target

        [Service]
        Type=simple
        ExecStartPre=/usr/bin/bash /opt/k3s-install.sh
        ExecStart=/usr/local/bin/k3s server --write-kubeconfig-mode 644 --disable traefik
        Restart=on-failure
        RestartSec=5
        StandardOutput=journal
        StandardError=journal

        [Install]
        WantedBy=multi-user.target

storage:
  files:
    - path: /etc/hostname
      mode: 0644
      contents:
        inline: "homelab"

    - path: /opt/k3s-install.sh
      mode: 0755
      contents:
        inline: |
          #!/usr/bin/env bash
          set -e
          if [ ! -x /usr/local/bin/k3s ]; then
              echo "Installing K3s static binary..."
              curl -Lo /usr/local/bin/k3s https://github.com/k3s-io/k3s/releases/latest/download/k3s
              chmod +x /usr/local/bin/k3s
          else
              echo "K3s binary already exists, skipping install."
          fi
